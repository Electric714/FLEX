name: Build FLEX Example Unsigned IPA

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: List schemes (sanity check)
        run: |
          xcodebuild -list -project Example/FLEXExample.xcodeproj

      - name: Resolve Swift package dependencies (safe even if none)
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Example/FLEXExample.xcodeproj \
            -scheme FLEXExample

      - name: Build FLEXExample (no signing, iOS Simulator)
        run: |
          set -euo pipefail
          xcodebuild \
            -project Example/FLEXExample.xcodeproj \
            -scheme FLEXExample \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            BUILD_DIR="$PWD/build" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            ONLY_ACTIVE_ARCH=NO \
            build

      - name: Create unsigned IPA (zip Payload/)
        run: |
          set -euo pipefail

          echo "Searching for FLEXExample.app under build/ ..."
          APP_PATH="$(find "$PWD/build" -type d -name "FLEXExample.app" | head -n 1 || true)"

          if [ -z "${APP_PATH}" ]; then
            echo "❌ FLEXExample.app not found. Dumping build directory:"
            find "$PWD/build" -maxdepth 6 -print || true
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          rm -rf Payload FLEXExample-unsigned.ipa
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          # -q quiet, -r recurse, -y store symlinks as symlinks
          zip -qry FLEXExample-unsigned.ipa Payload

          echo "✅ Created: FLEXExample-unsigned.ipa"
          ls -lh FLEXExample-unsigned.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: FLEXExample-unsigned-ipa
          path: FLEXExample-unsigned.ipa
          if-no-files-found: error
