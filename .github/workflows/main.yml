name: Build FLEX Example (unsigned)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: Debug repo structure (prove paths)
        run: |
          echo "Repo root:"
          ls -la
          echo "Example folder:"
          ls -la Example || true
          echo "Find xcodeproj/xcworkspace (depth 6):"
          find . -maxdepth 6 -name "*.xcodeproj" -print
          find . -maxdepth 6 -name "*.xcworkspace" -print

      - name: Install CocoaPods (if needed)
        run: |
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods -N
          fi
          pod --version

      - name: Pod install (Example/)
        working-directory: Example
        run: |
          pod install --repo-update
          ls -la

      - name: Pick workspace/project + list schemes (Example/)
        id: pick
        working-directory: Example
        run: |
          set -euo pipefail

          echo "After pods, available workspaces/projects:"
          find . -maxdepth 3 -name "*.xcworkspace" -print
          find . -maxdepth 3 -name "*.xcodeproj" -print

          # Prefer workspace created by CocoaPods
          WS="$(find . -maxdepth 3 -name "*.xcworkspace" -print | head -n 1 || true)"
          if [ -n "$WS" ]; then
            echo "kind=workspace" >> "$GITHUB_OUTPUT"
            echo "path=$WS" >> "$GITHUB_OUTPUT"
            xcodebuild -list -workspace "$WS"
            exit 0
          fi

          PROJ="$(find . -maxdepth 3 -name "*.xcodeproj" -print | head -n 1 || true)"
          if [ -n "$PROJ" ]; then
            echo "kind=project" >> "$GITHUB_OUTPUT"
            echo "path=$PROJ" >> "$GITHUB_OUTPUT"
            xcodebuild -list -project "$PROJ"
            exit 0
          fi

          echo "❌ No workspace/project found in Example/ even after pod install"
          exit 66

      - name: Build (unsigned, iOS Simulator)
        working-directory: Example
        run: |
          set -euo pipefail

          KIND="${{ steps.pick.outputs.kind }}"
          PTH="${{ steps.pick.outputs.path }}"

          # FLEX’s example target/scheme name can vary (often FLEXample).
          # If your logs show a different scheme, replace FLEXample below.
          SCHEME="FLEXample"

          if [ "$KIND" = "workspace" ]; then
            xcodebuild \
              -workspace "$PTH" \
              -scheme "$SCHEME" \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination 'generic/platform=iOS Simulator' \
              BUILD_DIR="$PWD/../build" \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGN_IDENTITY="" \
              ONLY_ACTIVE_ARCH=NO \
              build
          else
            xcodebuild \
              -project "$PTH" \
              -scheme "$SCHEME" \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination 'generic/platform=iOS Simulator' \
              BUILD_DIR="$PWD/../build" \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGN_IDENTITY="" \
              ONLY_ACTIVE_ARCH=NO \
              build
          fi

      - name: Create unsigned IPA (zip Payload/)
        run: |
          set -euo pipefail

          # Find the built .app inside build/
          APP_PATH="$(find "$PWD/build" -type d -name "*.app" | head -n 1 || true)"
          if [ -z "$APP_PATH" ]; then
            echo "❌ No .app found. Dump build dir:"
            find "$PWD/build" -maxdepth 6 -print || true
            exit 1
          fi

          rm -rf Payload FLEX-Example-unsigned.ipa
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          zip -qry FLEX-Example-unsigned.ipa Payload
          ls -lh FLEX-Example-unsigned.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: FLEX-Example-unsigned-ipa
          path: FLEX-Example-unsigned.ipa
          if-no-files-found: error
